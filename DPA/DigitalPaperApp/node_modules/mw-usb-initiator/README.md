# node-mw-usb-initiator

Win/MacにUSB接続された”Digital Paper"(DPT)を検出し、USB機器やNetwork Interfaceの情報を取得する。

 - Win/Mac への 対応デバイスの"USB SerialPort (CDC-ACM)"としての接続/切断の検出
 - Win/Mac に"USB Serial Port (CDC-ACM)"で接続された対応デバイスの"USB Ethernet (RNDIS/CDC-ECM)"への切り替え
 - Win/Mac への 対応デバイス の"USB Ethernet(RNDIS/CDC-ECM)"としての接続/切断の検出
 - "USB Ethernet (RNDIS/CDC-ECM)"として接続された対応デバイスの"IPv6 Link Local Address"の取得

#### [Changelog](https://github.com/LinfinyJapan/dps_node-mw-usb-detector/blob/master/CHANGELOG.md)


# Install

 1. GitHub上の [`node-mw-usb-initiator`](https://github.com/LinfinyJapan/dps_node-usb-initiator-mw.git) をローカルにクローンする
 2. `npm install` を使用して`node-mw-usb-initiator`をインストールする
```
> git clone git@github.com:LinfinyJapan/dps_node-mw-usb-initiator.git
> cd node-mw-usb-initiator
> npm install
```

### Common:

  - Python 2.x
  - [node-gyp](https://github.com/TooTallNate/node-gyp)

### Windows:

  - Visual Studio 2013
  - [Windows 8.1 SDK](http://msdn.microsoft.com/ja-jp/windows/desktop/bg162891)
    - "cfgmgr32.lib" を必要とするため

### Mac OS X:

 - xCode Command Line Tools
  - [Downloads for Apple Developers](https://developer.apple.com/downloads/) からダウンロード可能


# Usage

```js
var dptUsbInitiator = require('mw-usb-initiator');

// USB(CDC-ACM)接続通知の登録
dptUsbInitiator.on('add:serialport', function (device) {
  console.log('\n<SerialPort> Added\n', device);
});

// USB(CDC-ACM)切断通知の登録
dptUsbInitiator.on('remove:serialport', function (device) {
  console.log('\n<SerialPort> Removed\n', device);
});

// USB(RNDIS/CDC-ECM)接続通知の登録
dptUsbInitiator.on('add:ethernet', function (device) {
  console.log('\n<Ethernet> Added\n', device);
});

// USB(RNDIS/CDC-ECM)切断通知の登録
dptUsbInitiator.on('remove:ethernet', function (device) {
  console.log('\n<Ethernet> Removed\n', device);
});

// USBの接続/切断の検出処理を開始する
dptUsbInitiator.start(function (error, usbSerialArray, usbEtherArray) {
  if (error) {
    console.error(error);
    return;
  }
  console.log('\n<SerialPort> Started\n', usbSerialArray);
  console.log('\n<Ethernet> Started\n', usbEtherArray);
});
```

# [Interface](doc/interface.md)

## `start(callback)`
- Win/MacにUSB接続された対応デバイスの接続/切断の検出処理を開始する。
- 検出処理の開始時点で、Win/Macに"USB Serial Port (CDC-ACM)"または"USB Ethernet (RNDIS/CDC-ECM)"として接続されている対応デバイスの一覧をcallbackする。

##### Parameters:
- `callback`:
  - Win/Macへの対応デバイスのUSB接続/切断の検出処理の開始された際に呼び出されるcallback。
  - 検出処理の開始時点でWin/MacにUSB接続されている対応デバイスの一覧を通知する。

##### Example:
```js
var dptUsbInitiator = require('mw-usb-initiator');

dptUsbInitiator.start(function (error, usbSerialArray, usbEtherArray) {
  if (error) {
    console.error(error);
    return;
  }
  console.log('\n<SerialPort> Started\n', usbSerialArray);
  console.log('\n<Ethernet> Started\n', usbEtherArray);
});

/* Console output:
<SerialPort> Started
 [ { serialNumber: '012345678900002' } ]

<Ethernet> Started
 [ { serialNumber: '012345678900001',
    ipV6:
     { address: 'fe80::4133:b287:492b:3ec7',
       netmask: 'ffff:ffff:ffff:ffff::',
       family: 'IPv6',
       mac: '02:35:37:35:3b:3c',
       scopeid: 32,
       internal: false } } ]
*/
```

## `on(eventName, callback)`
- Win/Macに対する対応デバイスのUSB接続/切断のイベントを受信する。

##### Parameters:
 - `eventName`: 検出するイベントの指定
 	 - `add`: USB接続時のイベント
 	 	 - `add:serialport`: "USB Serial Port (CDC-ACM)"接続時のイベント
 	 	 - `add:ethernet`  : "USB Ethernet (RNDIS/CDC-ECM)"接続時のイベント
 	 - `remove`: USB切断時のイベント
 	 	 - `remove:serialport`: "USB Serial Port (CDC-ACM)"切断時のイベント
 	 	 - `remove:ethernet`  : "USB Ethernet (RNDIS/CDC-ECM)"切断時のイベント
 - `callback`: 指定されたイベントが検出された際に呼び出されるcallback

##### Notes: 
- "USB Serial Port(CDC-ACM)"接続時には、"USB Ethernet (RNDIS/CDC-ECM)"への切り替えにより、
  以下の順でイベントが発行される。
  1. `add:serialport`
  2. `remove:serialport`
  3. `add:ethernet`
- `add:ethernet` は、対応デバイスが"USB Ethernet (RNDIS/CDC-ECM)"で接続されたことを検知した後、
  IPv6 Address が取得できた際にcallbackされる。

##### Example:
```js
var dptUsbInitiator = require('mw-usb-initiator');

dptUsbInitiator.on('add:serialport', function (device) {
  console.log('\n<SerialPort> Added\n', device);
});

dptUsbInitiator.on('remove:serialport', function (device) {
  console.log('\n<SerialPort> Removed\n', device);
});

dptUsbInitiator.on('add:ethernet', function (device) {
  console.log('\n<Ethernet> Added\n', device);
});

dptUsbInitiator.on('remove:ethernet', function (device) {
  console.log('\n<Ethernet> Removed\n', device);
});

dptUsbInitiator.start(function (error, usbSerialArray, usbEtherArray) {
  if (error) {
    console.error(error);
    return;
  }
});

/* Console output:
<SerialPort> Added
 { serialNumber: '012345678900002' }

<SerialPort> Removed
 { serialNumber: '012345678900002' }

<Ethernet> Added
 { serialNumber: '012345678900002',
  ipV6:
   { address: 'fe80::29e6:35db:8aa6:d253',
     netmask: 'ffff:ffff:ffff:ffff::',
     family: 'IPv6',
     mac: '02:35:37:35:3b:3f',
     scopeid: 31,
     internal: false } }

<Ethernet> Removed
 { serialNumber: '012345678900002',
  ipV6:
   { address: 'fe80::29e6:35db:8aa6:d253',
     netmask: 'ffff:ffff:ffff:ffff::',
     family: 'IPv6',
     mac: '02:35:37:35:3b:3f',
     scopeid: 31,
     internal: false } }
*/
```

-----

# Debug

`node-mw-usb-initiator`自身のdebugに関する情報。

### Setup

 1. GitHub上の [`node-usb-detector-mw`](https://github.com/LinfinyJapan/dps_node-usb-detector-mw.git) をローカルにクローンする
 2. GitHub上の [`node-usb-ethernet-finder-mw`](https://github.com/LinfinyJapan/dps_node-usb-ethernet-finder-mw.git) をローカルにクローンする
 3. GitHub上の [`node-mw-usb-initiator`](https://github.com/LinfinyJapan/dps_node-usb-initiator-mw.git) をローカルにクローンする
 4. `npm link` および `npm install` を使用して`node-mw-usb-detector`をインストールする
```
> cd node-usb-detector-mw
> npm install
> npm link
  ...
> cd ../node-usb-ethernet-finder-mw
> npm install
> npm link
  ...
> cd ../node-mw-usb-detector
> npm install
> npm link usb-detector-mw
> npm link usb-ethernet-finder-mw
```
- Mac の場合には`sudo npm link`で実行する必要がある

