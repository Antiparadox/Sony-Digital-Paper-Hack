/**
	testserver.js
	
	creator:	kan.k
	created:	[2016-05-24 20:04:20+09:00]
	modified:	[2016-05-24 21:17:17+09:00]
	description:
	Test server
	
*/

const express =   require("express");
const multer  =   require('multer');

exports.launchTestServer = function(port) {
  var app         =   express();
  var storage =   multer.diskStorage({
	destination: function (req, file, callback) {
      callback(null, './uploads');
	},
	filename: function (req, file, callback) {
      callback(null, file.fieldname + '-' + Date.now());
	}
  });
  var upload = multer({ storage : storage}).single('userPhoto');

  ///////////////////////////////////
  ///	Expose File
  ///////////////////////////////////

  var baseContent = '0123456789';
  var data = '';
  for ( var i = 0; i < 100 * 1000 * 10; i ++ ) {
	data += baseContent;
  }
  var dataBuf = Buffer.from(data);

  app.get('/api/getfile',function(req,res){
	res.set('Content-Type', 'text/plain');
	res.send(dataBuf);
  });


  ///////////////////////////////////
  ///	Accept File
  ///////////////////////////////////

  app.post('/api/file',function(req,res){
	console.log('request detected:');
    upload(req,res,function(err) {
	  console.log('request ended:');
      if(err) {
		console.error('error: ', err);
        return res.end("Error uploading file.");
      }
	  
      res.end("File is uploaded");
    });
  });


  ///////////////////////////////////
  ///	Start Server
  ///////////////////////////////////

  return new Promise(function(resolve, reject) {
	app.listen(port,function(){
      console.log("Working on port : ", port);
	  resolve(app);
	});
  });
}

