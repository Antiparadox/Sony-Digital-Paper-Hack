/**
	testportfwdr.js
	
	creator:	kan.k
	created:	[2016-05-24 21:01:43+09:00]
	modified:	[2016-05-24 21:17:15+09:00]
	description:

	Test portfwdr
*/

const ts = require('./testserver');
const tc = require('./testclient');

var pf = require('../portfwdr');
var toIpAddr = '127.0.0.1'
var toPortHttp = 3000

ts.launchTestServer(3000).then(function(app) {
  pf.start(toIpAddr, toPortHttp, toPortHttp, function() {
	var starttime = process.uptime();
	var promises = [];
	for ( var i = 0; i < 10; i++ ) {
	  console.assert(pf.getHttpPort() !== toPortHttp);
	  // promises.push(tc.getTestFile(pf.getHttpPort()));
	  promises.push(tc.getTestFile(toPortHttp));
	}
	Promise.all(promises).then(function(values) {
	  var endtime = process.uptime();
	  var datasize = 0;
	  for ( var i in values ) {
		datasize += values[i];
	  }
	  console.log('Total Elapsed: ', endtime - starttime);
	  console.log('Throughput [Bytes per second]: ',
				  numberWithCommas(Math.round(datasize / (endtime - starttime))));
	  app.close();
	});
  });
});

function numberWithCommas(x) {
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}


