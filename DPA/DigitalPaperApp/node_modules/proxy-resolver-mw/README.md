# node-proxy-resolver-mw

Windows/macOS(OS X) のプロキシ設定を取得する。

## 機能
- 指定のURLに接続する際に使用されるプロキシサーバーの設定（ホスト名:ポート番号）を取得する。

### Windows の場合
- Internet Explorer のプロキシ設定を使用する
  - [インターネットのプロパティ] > [接続] > [LANの設定]
- 自動構成に対応する
  - "Web Proxy Auto-Discovery (WPAD)"による自動構成
    - [設定を自動的に検出する] がチェックされていた場合 
  - "Proxy Auto-Configuration (PAC)"による自動構成
    - [自動構成のスクリプトを使用する] にチェックされていた場合
- 以下の順序にてプロキシ設定を確認する
  1. "Web Proxy Auto-Discovery (WPAD)"による自動構成
  2. "Proxy Auto-Configuration (PAC)"による自動構成
  3. 手動でのプロキシ設定（ホスト名:ポート番号）

### macOS(OS X) の場合
- システムのインターネット接続のプロキシ設定を使用する
  - [自動プロキシ検出]および[自動プロキシ構成]に対応する
  - 使用されるプロキシ設定の優先順位はシステムによって決定される


## インストール
```
$ git clone github.com:LinfinyJapan/dps_node-proxy-resolver-mw.git
$ cd node-proxy-resolver-mw
$ npm install
```

## インタフェース
- [interface.md](doc/interface.md)


## 使い方

```js
const proxyResolver = require('proxy-resolver-mw');

const targetUrl = 'https://github.com/';
const userAgent = 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.99 Safari/537.36';

proxyResolver.getProxy(targetUrl, userAgent, function (error, proxy) {
  if (error) {
    console.error(error);
    return;
  }
  console.log('Proxy: ' + proxy);
});

/* Console output:
Proxy: proxy.sonycity.sony.co.jp:10080
*/
```

## デバッグ方法

### Windows の場合

Visual Studio を使用して C/C++ のコードをデバッグする際の手順です。

0. 事前に npm install にて依存するmoduleなどをインストールしておく
  ```
  $ cd node-proxy-resolver-mw
  $ npm install
  
  ```
1. node-gyp でビルドを行い、Visual Studio で solution file を開く
  ```
  $ node-gyp build
  $ start ./build/binding.sln
  
  ```
2. "proxy_resolver"プロジェクトのプロパティを開く
3. [構成(C):] を [Release] に変更する
4. [構成プロパティ] > [デバッグ] を開く
5. [コマンド]と[コマンド引数]の値を以下のように設定する
  - コマンド: 
    - node.exe のファイルパス
    - 例）C:\Program Files (x86)\nodejs\node.exe
  - コマンド引数：
    - 実行対象の js ファイルのパス
    - 例）D:\node-proxy-resolver-mw\example\example.js
6. Releaseビルドする
7. デバッグ実行する


### macOS(OS X) の場合

Xcode を使用して C/C++ のコードをデバッグする際の手順です。

0. 事前に npm install にて依存するmoduleなどをインストールしておく
  ```
  $ cd node-proxy-resolver-mw
  $ npm install
  
  ```
1. node-gyp で Xcode の project file を生成し、Xcodeで開く
  ```
  $ cd node-proxy-resolver-mw
  $ node-gyp build
  $ node-gyp configure -- -f xcode
  $ open ./build/binding.xcodeproj/
  
  ```
2. 実行ファイルに node.js を指定する
  1. Xcode のメニューから [Product] > [Scheme] > [Edit Scheme] と選択する
  2. ダイアログ上で [Run] > [Info] を選択し、[Executable] を [Other...] に設定する
  3. [Choose an executable to launch] という実行ファイルの選択ダイアログが表示される
  4. ターミナルで which を実行し、node.js のインストールパスをコピーする
    ```
    $ which node
    /usr/local/bin/node
    
    ```
  5. 実行ファイルの選択ダイアログ上で [Command] + [Shift] + [G] を入力する
  6. [Go to the folder:] に node.js のインストールパスを貼り付け、[Choose]を押す
3. 実行時の引数に js ファイルを指定する
  1. ダイアログ上で [Run] > [Arguments] を選択し、[Arguments Passed On Launch] の [＋] を押す
  2. 実行対象のjsファイルの絶対パス（\"で括る）を入力し、[Close] を押す
4. リンクするライブラリを設定する
  1. Xcode上の左のペインから [binding] を選択する
  2. Xcode上の中央のペインから [Build Phases] を選択する
  3. [Link Binary With Libraries] の [＋] を押し、以下を追加する
    - CoreFoundation.framework
    - CFNetwork.framework
5．ビルドして、デバッグ実行する

[補足説明]
- ”npm install” や "node-gyp build"を行うと、Xcode の project file が削除されます
  - ”node-gyp configure -- -f xcode”を実行して、project file を再生成してください


