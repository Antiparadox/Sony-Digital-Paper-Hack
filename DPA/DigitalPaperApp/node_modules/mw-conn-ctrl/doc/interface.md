<a name="module_mw-conn-ctrl"></a>

## mw-conn-ctrl
<p>This module must be loaded from Electron Renderer.</p>


* [mw-conn-ctrl](#module_mw-conn-ctrl)
    * _static_
        * [.createConnCtrl()](#module_mw-conn-ctrl.createConnCtrl)
    * _inner_
        * [~ConnCtrl](#module_mw-conn-ctrl..ConnCtrl)
            * [.connect(deviceId, callback)](#module_mw-conn-ctrl..ConnCtrl+connect)
            * [.getBaseUrl()](#module_mw-conn-ctrl..ConnCtrl+getBaseUrl) ⇒ <code>string</code> &#124; <code>null</code>
            * [.getDeviceId()](#module_mw-conn-ctrl..ConnCtrl+getDeviceId) ⇒ <code>string</code>
            * [.auth(callback)](#module_mw-conn-ctrl..ConnCtrl+auth)
            * [.checkConnection(callback)](#module_mw-conn-ctrl..ConnCtrl+checkConnection)
            * [.detectDisconnected(deviceId, remoteIp)](#module_mw-conn-ctrl..ConnCtrl+detectDisconnected)
            * [.getDevice()](#module_mw-conn-ctrl..ConnCtrl+getDevice) ⇒ <code>Object</code>
        * ["deviceConnChangeFailed" (error)](#event_deviceConnChangeFailed)
        * ["deviceAppear" (device)](#event_deviceAppear)
        * ["deviceDisappear" (device)](#event_deviceDisappear)
        * ["deviceConnChanging" (device)](#event_deviceConnChanging)
        * ["deviceConnChanged" (device)](#event_deviceConnChanged)

<a name="module_mw-conn-ctrl.createConnCtrl"></a>

### mw-conn-ctrl.createConnCtrl()
<p>Create ConnCtrl instance.</p>

**Kind**: static method of <code>[mw-conn-ctrl](#module_mw-conn-ctrl)</code>  
<a name="module_mw-conn-ctrl..ConnCtrl"></a>

### mw-conn-ctrl~ConnCtrl
<p>Connection Control class for MilkyWay</p>

**Kind**: inner class of <code>[mw-conn-ctrl](#module_mw-conn-ctrl)</code>  

* [~ConnCtrl](#module_mw-conn-ctrl..ConnCtrl)
    * [.connect(deviceId, callback)](#module_mw-conn-ctrl..ConnCtrl+connect)
    * [.getBaseUrl()](#module_mw-conn-ctrl..ConnCtrl+getBaseUrl) ⇒ <code>string</code> &#124; <code>null</code>
    * [.getDeviceId()](#module_mw-conn-ctrl..ConnCtrl+getDeviceId) ⇒ <code>string</code>
    * [.auth(callback)](#module_mw-conn-ctrl..ConnCtrl+auth)
    * [.checkConnection(callback)](#module_mw-conn-ctrl..ConnCtrl+checkConnection)
    * [.detectDisconnected(deviceId, remoteIp)](#module_mw-conn-ctrl..ConnCtrl+detectDisconnected)
    * [.getDevice()](#module_mw-conn-ctrl..ConnCtrl+getDevice) ⇒ <code>Object</code>

<a name="module_mw-conn-ctrl..ConnCtrl+connect"></a>

#### connCtrl.connect(deviceId, callback)
<p>Connect to designated device. After this procedure succeed, Web
API will be able to triggered by using getBaseUrl() URL.</p>
<p>Regarding authentication, first authentication will be done by this
procedure. But the credential of this auth may be expire by
opponent devices behavior. For such a case, the Web API will be
return such a status, please call auth().</p>
<p>When more than one connection are detected for designated device,
the most appropriate connection is selected according to
following priority:</p>
<ol>
<li>Deneb direct USB-ether</li>
<li>IPv4 of other network interface.</li>
<li>IPv6 of other network interface.(should)</li>
</ol>
<p>Before this procedure succeed, getBaseUrl() and getDevice() will
return <code>null</code>.</p>
<p>When device is not found, E_MW_DEVICE_NOT_FOUND will be returned
to callback function. In this case, getDeviceId() will be set to
last specified deviceId, and deviceAppear event is ready to be
emitted.</p>
<p>指定されたデバイスに接続する。この処理が完了すると、getBaseUrl()
のURLを通じてWeb APIを呼ぶことができる様になる。</p>
<p>認証に関しては、初回の認証はこの処理の中で行われる。ただし、認証
のCredentialは、対向デバイスの動作によって期限切れになる場合があ
る。その場合は、Web APIが、認証が必要な旨のStatusを返すので、
auth() を呼び出す必要がある。</p>
<p>指定したdeviceIdに対応する接続が複数検出できている場合には、その
時点で接続に利用するべき情報を返す。
優先順位は、次の順:</p>
<ol>
<li>Deneb直結 USB-ether</li>
<li>他のネットワークインターフェースのIPv4</li>
<li>他のネットワークインターフェースのIPv6 (できれば)</li>
</ol>
<p>この処理が、成功して完了するまで、getBaseUrl() と、getDevice() は
nullを返す。</p>
<p>デバイスが見つからない場合には、E_MW_DEVICE_NOT_FOUND がCallback
に返ってくる。ただしこの場合には、 getDeviceId() は最後に指定され
たdeviceIdを返し、deviceAppearイベントは受信可能な状態になる。</p>

**Kind**: instance method of <code>[ConnCtrl](#module_mw-conn-ctrl..ConnCtrl)</code>  

| Param | Type | Description |
| --- | --- | --- |
| deviceId | <code>string</code> | <p>The deviceId of the device to connect.</p> |
| callback | <code>function</code> | <p>The function to be called when   connect is done. When failed to connect, the Error object will   be passed as a first argument. The error code of Error object can be:</p> <ul> <li>E_MW_ALREADY_RUNNING</li> <li>E_MW_DEVICE_NOT_FOUND</li> <li>E_MW_PORTFWDR_PORT_UNAVAILABLE</li> <li>E_MW_PORTFWDR_FAILED_TO_LISTEN_PORT</li> <li>E_MW_DEVICE_CONN_FAILED</li> <li>E_MW_AUTH_FAILED</li> <li>E_MW_STORE_SET_DEVICE_ID_FAILED</li> <li>E_MW_STORE_GET_DEVICE_ID_FAILED</li> <li>E_MW_STORE_GET_PRIVKEY_FAILED</li> <li>E_MW_STORE_GEN_KEYPAIR_FAILE <br> 接続が完了したときに呼び出されるCallback関数。接続に失敗した場 合、Errorオブジェクトが第一引数に渡される。Errorオブジェクトの エラーコードは次の値をとりうる:</li> <li>E_MW_ALREADY_RUNNING</li> <li>E_MW_DEVICE_NOT_FOUND</li> <li>E_MW_PORTFWDR_PORT_UNAVAILABLE</li> <li>E_MW_PORTFWDR_FAILED_TO_LISTEN_PORT</li> <li>E_MW_DEVICE_CONN_FAILED</li> <li>E_MW_AUTH_FAILED</li> <li>E_MW_STORE_SET_DEVICE_ID_FAILED</li> <li>E_MW_STORE_GET_DEVICE_ID_FAILED</li> <li>E_MW_STORE_GET_PRIVKEY_FAILED</li> <li>E_MW_STORE_GEN_KEYPAIR_FAILE</li> </ul> |

<a name="module_mw-conn-ctrl..ConnCtrl+getBaseUrl"></a>

#### connCtrl.getBaseUrl() ⇒ <code>string</code> &#124; <code>null</code>
<p>Get base URL to call Web API for current connected device.
<br>
現在選択しているデバイスの、Web APIを呼び出すためのBase URLを取得する。</p>

**Kind**: instance method of <code>[ConnCtrl](#module_mw-conn-ctrl..ConnCtrl)</code>  
**Returns**: <code>string</code> &#124; <code>null</code> - <p>The base part of URL to call Web API. The
  scheme part and host name part is included. (e.g.:
  &quot;https://opponent.device.local&quot;)</p>  
**Note**: BaseURL の特に、Host名は、通信仕様上AuthのCredentialと紐付  けられている。そのため、BaseURLは、Authも行うこのモジュールから  取得して利用する設計としている。  
<a name="module_mw-conn-ctrl..ConnCtrl+getDeviceId"></a>

#### connCtrl.getDeviceId() ⇒ <code>string</code>
**Kind**: instance method of <code>[ConnCtrl](#module_mw-conn-ctrl..ConnCtrl)</code>  
**Returns**: <code>string</code> - <p>The deviceId of the device currently selected.</p>  
<a name="module_mw-conn-ctrl..ConnCtrl+auth"></a>

#### connCtrl.auth(callback)
<p>Rerun authentication procedure. This assumed to be called when
Web API returns status indicates authentication required.
<br>
認証手続きを再度行う。このメソッドは、Web APIが認証が必要な旨のス
テータスを返した場合に呼び出される事を想定している。</p>

**Kind**: instance method of <code>[ConnCtrl](#module_mw-conn-ctrl..ConnCtrl)</code>  

| Param | Type | Description |
| --- | --- | --- |
| callback | <code>function</code> | <p>The function to be called when   authentication is done. When failed to auth, the Error object   will be passed as a first argument. The error code of Error   object definition is same as <code>connect()</code>   <br>   認証手続きが完了したことを受け取るためのコールバック関数。認証   に失敗した場合には、Errorオブジェクトが第一引数として返る。エラー   コードの定義は、<code>connect()</code>と同じ。</p> |

<a name="module_mw-conn-ctrl..ConnCtrl+checkConnection"></a>

#### connCtrl.checkConnection(callback)
<p>Actively check connection between selected device.</p>
<p>It is assumed that device disappear being detected by failer to
call Web API in most case. This function is prepared for the case
UI want to know the device connectivity without any operating functional
Web API call.</p>
<p><br>
能動的に対向デバイスとの接続を確認する。</p>
<p>ほとんどのケースでは、Web APIの呼び出しの失敗によって、デバイスが
接続できなくなった事を検知すると想定される。この関数は、UIが、通常のWeb APIによる操作を</p>

**Kind**: instance method of <code>[ConnCtrl](#module_mw-conn-ctrl..ConnCtrl)</code>  

| Param | Type | Description |
| --- | --- | --- |
| callback | <code>function</code> | <p>The function to be called when   checking is done. When the device could not be connected, the   Error object will be passed as a first argument.   <br>   接続確認がが完了したことを受け取るためのコールバック関数。接続   できない場合には、Errorオブジェクトが第一引数として返る。</p> |

<a name="module_mw-conn-ctrl..ConnCtrl+detectDisconnected"></a>

#### connCtrl.detectDisconnected(deviceId, remoteIp)
<p>The function to notify that the target device is disconnected.
When calling Web API from upper layer, the caller may know device
is no longer connectable by result of XHR. In this case the
caller should call this function.
<br>
指定したデバイスへの接続が切断された事を通知するための関数。より
上位レイヤーからWeb APIを呼び出した場合に、XHRからの戻り値等で対
象のデバイスがすでに接続できなくなっている事を検出できる。
その場合に呼び出し側でこの関数を呼んでデバイスが消えたことを通知
する。</p>

**Kind**: instance method of <code>[ConnCtrl](#module_mw-conn-ctrl..ConnCtrl)</code>  

| Param | Type |
| --- | --- |
| deviceId | <code>string</code> | 
| remoteIp | <code>string</code> | 

<a name="module_mw-conn-ctrl..ConnCtrl+getDevice"></a>

#### connCtrl.getDevice() ⇒ <code>Object</code>
<p>Get device object that currently selected.</p>

**Kind**: instance method of <code>[ConnCtrl](#module_mw-conn-ctrl..ConnCtrl)</code>  
**Returns**: <code>Object</code> - <p>Device
  information, The list of scanned devices. When remoteIp is IPv6
  Link Local address, scope Id also be set.
  <br>
  スキャンされているデバイスのPropertyを返す。remoteIpが、IPv6 Link
  Local Addressである場合には、スコープID付きのIPが返される。
  <code>deviceId</code>は、デバイスユニークなID。<code>name</code> は、デバイスのホスト名。
  <code>phyType</code>は、物理的な接続方式で、discovery.PHY_TYPE_USB か、
  discovery.PHY_TYPE_OTHER を返す。</p>  
<a name="event_deviceConnChangeFailed"></a>

### "deviceConnChangeFailed" (error)
<p>Connection change failed. When this event is issued, the module
will be disconnected status. But the 'deviceDisappear' event will
not be emit.
<br>
デバイスへの接続方法の切り替えが失敗した。このイベントがとんだ場
合は、モジュールは切断状態になる。ただし、'deviceDisappear'イベン
トは発行されない。</p>

**Kind**: event emitted by <code>[mw-conn-ctrl](#module_mw-conn-ctrl)</code>  

| Param | Type | Description |
| --- | --- | --- |
| error | <code>Error</code> | <p>The reason why device connection change failed.</p> |

<a name="event_deviceAppear"></a>

### "deviceAppear" (device)
<p>Indicates a selected device appear. The object with deviceId will
be passed. Even when this event is issued, the module will not
connect until connect() is explicitly called.
<br>
選択されているデバイスが、登場したことを示す。deviceId付きのオブ
ジェクトが渡される。このイベントが発行されても、connect()が明示的
に呼び出されるまで、このモジュールはデバイスに接続しない。</p>

**Kind**: event emitted by <code>[mw-conn-ctrl](#module_mw-conn-ctrl)</code>  

| Param | Type |
| --- | --- |
| device | <code>Object</code> | 

<a name="event_deviceDisappear"></a>

### "deviceDisappear" (device)
<p>Indicates the device disappear is detected. The object with
deviceId will be passed. After this event received all Web API
call assumed to fail.
<br>
デバイスが、見えなくなったことが検知された事を示す。deviceId付き
のオブジェクトが渡される。このイベントの後は全てのWeb API呼び出し
は失敗する事が想定される。</p>

**Kind**: event emitted by <code>[mw-conn-ctrl](#module_mw-conn-ctrl)</code>  

| Param | Type |
| --- | --- |
| device | <code>Object</code> | 

<a name="event_deviceConnChanging"></a>

### "deviceConnChanging" (device)
<p>Indicate a way to connection is changing. After this event is
issued, the module attempt to reconnect by new connection. Before
deviceConnChanged event is issued, Web API call may be fail.
<br>
デバイスへの接続方法が切り替わる事を示す。このイベントが発行され
てから、 モジュールは新しい接続での接続処理を行う。deviceConnChanged
イベントが受信できるまでは、Web APIは失敗する場合がある。</p>

**Kind**: event emitted by <code>[mw-conn-ctrl](#module_mw-conn-ctrl)</code>  

| Param | Type |
| --- | --- |
| device | <code>Object</code> | 

<a name="event_deviceConnChanged"></a>

### "deviceConnChanged" (device)
<p>Indicate a way to connection has been changed. After this event
is received caller should get getBaseUrl() again to call Web API.
<br>
デバイスへの接続方法が切り替わったことを示す。このイベントを受信
してから、呼び出し元は getBaseUrl() を再度呼び出して、Web APIをコー
ルする。</p>

**Kind**: event emitted by <code>[mw-conn-ctrl](#module_mw-conn-ctrl)</code>  

| Param | Type |
| --- | --- |
| device | <code>Object</code> | 

