'use strict';

const log_error = require('debug')('mw-automagic-client:disclaimer-xml-parser:error');
const log_debug = require('debug')('mw-automagic-client:disclaimer-xml-parser:debug');

const xml2js = require('xml2js');
const mwe = require('mw-error');


class DisclaimerXmlParser {

  /**
   * 「免責」のXMLを解析する。
   *
   * @param {string} xml        文字列形式の「免責」
   * @param {string} localeCode Win/Macのロケール情報（Auto Magic ロケールコード）
   * @param {function} callback 処理結果通知用のcallback関数
   */
  static parse(xml, localeCode, callback) {
    log_debug('parse()');

    if (typeof xml !== 'string') {
      const err = new TypeError('[ERROR] xml must be a string. (' + typeof xml + ')');
      log_error(err);
      throw err;
    }

    if (typeof callback !== 'function') {
      const err = new TypeError('[ERROR] callback must be a function. (' + typeof callback + ')');
      log_error(err);
      throw err;
    }

    const parser = new xml2js.Parser({ trim: true });
    parser.parseString(xml, function (err, result) {
      if (err) {
        callback(mwe.genError(mwe.E_MW_EXT_HTTP_UNEXPECTED_VALUE, 'Parse failed.', err));
        return;
      }

      const disclaimerMap = new Map();
      try {
        const disclaimerArray = result.NoticeFile.Notice;
        for (let i = 0; i < disclaimerArray.length; i++) {
          const disclaimer = disclaimerArray[i];

          // Locale
          const locale = disclaimer.$.Locale.toUpperCase();
          if (!locale) {
            callback(mwe.genError(mwe.E_MW_EXT_HTTP_UNEXPECTED_VALUE, 'Locale is not found.'));
            return;
          }

          // Text
          const strings = disclaimer.Text[0];
          if (!strings) {
            callback(mwe.genError(mwe.E_MW_EXT_HTTP_UNEXPECTED_VALUE, 'Text is not found.'));
            return;
          }

          disclaimerMap.set(locale, strings);          
        }

        // DefaultLocale
        const defaultLocale = result.NoticeFile.$.DefaultLocale.toUpperCase();
        if (!disclaimerMap.has(defaultLocale)) {
          callback(mwe.genError(mwe.E_MW_EXT_HTTP_UNEXPECTED_VALUE,
          'DefaultLocale is invalid.(' + defaultLocale + ')'));
          return;
        }

        // Win/Mac のロケール情報に合った文言を探す
        let strings = null;
        if (localeCode) {
          strings = disclaimerMap.get(localeCode);
        }
        if (!strings) {
          strings = disclaimerMap.get(defaultLocale);
        }

        callback(null, strings);
      }
      catch (e) {
        let err = e;
        if (!(err instanceof Error)) {
          err = new Error('Error: ' + e);
        }
        callback(mwe.genError(mwe.E_MW_EXT_HTTP_UNEXPECTED_VALUE, 'Parse failed.', err));
        return;
      }
    });
  }
}

module.exports = DisclaimerXmlParser;
