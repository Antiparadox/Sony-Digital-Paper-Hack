//
//  WinErrorCode.h
//
//  Copyright 2016 Sony Corporation
//

#pragma once

#include <winerror.h>
#include <windows.h>
#include <cfgmgr32.h>
#include <string>

class WinErrorCode
{
public:
	static std::string ToString(/*[in]*/ ULONG win32Err)
	{
		std::string message;

		LPVOID lpMsgBuf = NULL;		
		::FormatMessageA(
			FORMAT_MESSAGE_ALLOCATE_BUFFER |
			FORMAT_MESSAGE_FROM_SYSTEM,
			NULL,
			win32Err,
			MAKELANGID(LANG_ENGLISH, SUBLANG_ENGLISH_US),
			(LPSTR)&lpMsgBuf,
			0,
			NULL
			);
		if (lpMsgBuf) {
			message = (LPSTR)lpMsgBuf;
			::LocalFree(lpMsgBuf);
			lpMsgBuf = NULL;
		}

		return "WIN:" + std::to_string(win32Err) + ":" + message;
	}

	static std::string GetLastError()
	{
		const ULONG errCode = ::GetLastError();
		return WinErrorCode::ToString(errCode);
	}

	static std::string ToWinErrStr(/*[in]*/ CONFIGRET cmReturnCode)
	{
		const ULONG win32Err = ::CM_MapCrToWin32Err(cmReturnCode, ERROR_UNIDENTIFIED_ERROR);
		return WinErrorCode::ToString(win32Err) + ":CONFIGRET:" + std::to_string(cmReturnCode);
	}	
};

