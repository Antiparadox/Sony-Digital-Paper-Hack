//
//  UsbDeviceFinder class　
//
//  Windowsに接続されているUSB機器を検出するクラス。
//
//  Copyright 2016 Sony Corporation
//

#pragma once

#include <windows.h>
#include <cfgmgr32.h>
#include <vector>
#include <memory>
#include "../tstring.h"
#include "AutoBinaryPtr.h"


class UsbDeviceFinder
{
public:

	struct USB_DEVICE {
		tstring										sPnpDeviceId;
		tstring										sDeviceDesc;
		tstring										sFriendlyName;
		tstring										sManufacturer;
		tstring										sClass;
		tstring										sService;
		UINT16										idVendor;
		UINT16										idProduct;
		tstring										sSerialNumber;
		std::vector<std::shared_ptr<USB_DEVICE>>	vChildList;
	};

	static std::string FindUsbDevices(
		/*[in]*/ const UINT16 idVendor,
		/*[in]*/ const UINT16 idProduct,
		/*[out]*/ std::vector<std::shared_ptr<USB_DEVICE>>& rvDeviceList
		);

	static std::string FindUsbDevices(
		/*[in]*/ tstring& rsPnpDeviceId,
		/*[out]*/ std::vector<std::shared_ptr<USB_DEVICE>>& rvDeviceList
		);

	static std::string EnumUsbDevices(
		/*[out]*/ std::vector<std::shared_ptr<USB_DEVICE>>& rvDeviceList
		);

	static void ExtractVidPidSerial(
		/*[in]*/ const tstring& rsPnpDeviceId,
		/*[out]*/ UINT16& idVendor,
		/*[out]*/ UINT16& idProduct,
		/*[out]*/ tstring* psSerialNumber
		);

private :
	UsbDeviceFinder(){};

	static void FindUsbDevices(
		/*[in]*/ const tstring& rTargetDevice,
		/*[in]*/ const DEVINST ulDevInst,
		/*[in]*/ std::shared_ptr<USB_DEVICE> spParentDevice,
		/*[out]*/ std::vector<std::shared_ptr<USB_DEVICE>>& rvDeviceList
		);

	static void GetDeviceInfo(
		/*[in]*/ const DEVINST ulDevInst,
		/*[in,out]*/ std::shared_ptr<USB_DEVICE>& spDevice
		);

	static std::string GetDeviceProperty(
		/*[in]*/ const DEVINST ulDevInfoSet,
		/*[in]*/ const ULONG ulPropertyId,
		/*[out]*/ tstring& rvProperty
		);

	static std::string GetDeviceProperties(
		/*[in]*/ const DEVINST ulDevInfoSet,
		/*[in]*/ const ULONG ulPropertyId,
		/*[out]*/ std::vector<tstring>& rvProperties
		);

	static std::vector<tstring> GetPropertyStrings(
		/*[in]*/ const ULONG ulRegType,
		/*[in]*/ const ULONG ulDataSize,
		/*[in]*/ const AutoBinaryPtr& rspData
		);

};
